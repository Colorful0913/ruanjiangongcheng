<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.manage.mapper.DormRepairMapper">

    <!-- 结果集映射 -->
    <resultMap type="com.ruoyi.manage.domain.DormRepair" id="DormRepairResult">
        <result property="repairId"       column="repair_id"       />
        <result property="roomId"         column="room_id"         />
        <result property="reportUserId"   column="report_user_id"  />

        <result property="roomNumber" column="room_number"/>
        <result property="buildingCode" column="building_code"/>
        <result property="studentNumber" column="student_number"/>
        <result property="studentName" column="student_name"/>


        <result property="description"    column="description"     />
        <result property="images"         column="images"          />
        <result property="workerUserId"   column="worker_user_id"  />
        <result property="feedback"       column="feedback"        />
        <result property="status"         column="status"          />
        <result property="delFlag"        column="del_flag"        />
        <result property="createBy"       column="create_by"       />
        <result property="createTime"     column="create_time"     />
        <result property="updateBy"       column="update_by"       />
        <result property="updateTime"     column="update_time"     />
        <result property="remark"         column="remark"          />
    </resultMap>

    <!-- 基础查询字段 -->
<!--    <sql id="selectDormRepairVo">-->
<!--        select repair_id, room_id, report_user_id, description, images,-->
<!--               worker_user_id, feedback, status, del_flag, create_by,-->
<!--               create_time, update_by, update_time, remark-->
<!--        from tb_dorm_repair-->
<!--    </sql>-->


    <!-- 修改 selectDormRepairVo -->
    <sql id="selectDormRepairVo">
        select dr.repair_id, dr.room_id, dr.report_user_id, dr.description, dr.images, dr.worker_user_id, dr.feedback, dr.status, dr.del_flag, dr.create_by, dr.create_time, dr.update_by, dr.update_time, dr.remark,
               rom.room_number,
               building.building_code,
               student.student_number,
               student.remark as student_name
        from tb_dorm_repair dr
                 left join tb_dorm_room rom on dr.room_id = rom.room_id
                 left join tb_dorm_building building on rom.building_id = building.building_id
                 left join tb_dorm_student student on dr.report_user_id = student.user_id
    </sql>



    <!-- 查询维修报修列表（支持MyRepairService按reportUserId过滤） -->
<!--    <select id="selectDormRepairList" parameterType="com.ruoyi.manage.domain.DormRepair" resultMap="DormRepairResult">-->
<!--        <include refid="selectDormRepairVo"/>-->
<!--        <where>-->
<!--            &lt;!&ndash; 逻辑删除过滤：只查询未删除的数据 &ndash;&gt;-->
<!--            del_flag = '0'-->
<!--            &lt;!&ndash; 房间ID查询条件 &ndash;&gt;-->
<!--            <if test="roomId != null">and room_id = #{roomId}</if>-->
<!--            &lt;!&ndash; 报修人ID查询条件（MyRepairService核心过滤条件） &ndash;&gt;-->
<!--            <if test="reportUserId != null">and report_user_id = #{reportUserId}</if>-->
<!--            &lt;!&ndash; 问题描述查询条件 &ndash;&gt;-->
<!--            <if test="description != null and description != ''">and description = #{description}</if>-->
<!--            &lt;!&ndash; 图片URL查询条件 &ndash;&gt;-->
<!--            <if test="images != null and images != ''">and images = #{images}</if>-->
<!--            &lt;!&ndash; 维修工ID查询条件 &ndash;&gt;-->
<!--            <if test="workerUserId != null">and worker_user_id = #{workerUserId}</if>-->
<!--            &lt;!&ndash; 维修反馈查询条件 &ndash;&gt;-->
<!--            <if test="feedback != null and feedback != ''">and feedback = #{feedback}</if>-->
<!--            &lt;!&ndash; 状态查询条件（0待处理,1维修中,2已完成） &ndash;&gt;-->
<!--            <if test="status != null and status != ''">and status = #{status}</if>-->
<!--        </where>-->
<!--        &lt;!&ndash; 按创建时间倒序，最新的报修在前 &ndash;&gt;-->
<!--        order by create_time desc-->
<!--    </select>-->


    <!-- 修改 selectDormRepairList 查询 -->
    <select id="selectDormRepairList" parameterType="DormRepair" resultMap="DormRepairResult">
        <include refid="selectDormRepairVo"/>
        <where>
            <if test="roomId != null "> and dr.room_id = #{roomId}</if>
            <if test="reportUserId != null "> and dr.report_user_id = #{reportUserId}</if>
            <if test="workerUserId != null "> and dr.worker_user_id = #{workerUserId}</if>
            <if test="status != null  and status != ''"> and dr.status = #{status}</if>
            <!-- 明确指定是repair表的del_flag字段 -->
            <if test="delFlag != null  and delFlag != ''"> and dr.del_flag = #{delFlag}</if>


            <!-- 添加新的查询条件 -->
            <if test="studentNumber != null and studentNumber != ''"> and student.student_number like concat('%', #{studentNumber}, '%')</if>
            <if test="studentName != null and studentName != ''"> and student.remark like concat('%', #{studentName}, '%')</if>
            <if test="buildingCode != null and buildingCode != ''"> and building.building_code like concat('%', #{buildingCode}, '%')</if>
            <if test="roomNumber != null and roomNumber != ''"> and rom.room_number like concat('%', #{roomNumber}, '%')</if>
            <if test="workerName != null and workerName != ''">
                and (
                (dr.worker_user_id = 5 and #{workerName} = '维修工1') or
                (dr.worker_user_id = 6 and #{workerName} = '维修工2')
                )
            </if>

        </where>
    </select>






    <!-- 根据ID查询维修报修（支持MyRepairService验证数据归属） -->
<!--    <select id="selectDormRepairByRepairId" parameterType="Long" resultMap="DormRepairResult">-->
<!--        <include refid="selectDormRepairVo"/>-->
<!--        where repair_id = #{repairId}-->
<!--        and del_flag = '0'  &lt;!&ndash; 过滤已删除数据 &ndash;&gt;-->
<!--    </select>-->

    <!-- 修改通过ID查询单个报修记录的语句 -->
    <select id="selectDormRepairByRepairId" parameterType="Long" resultMap="DormRepairResult">
        <include refid="selectDormRepairVo"/>
        where dr.repair_id = #{repairId} and dr.del_flag = '0'
    </select>




    <!-- 新增维修报修 -->
    <insert id="insertDormRepair" parameterType="com.ruoyi.manage.domain.DormRepair" useGeneratedKeys="true" keyProperty="repairId">
        insert into tb_dorm_repair
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="roomId != null">room_id,</if>
            <if test="reportUserId != null">report_user_id,</if>
            <if test="description != null and description != ''">description,</if>
            <if test="images != null and images != ''">images,</if>
            <if test="workerUserId != null">worker_user_id,</if>
            <if test="feedback != null and feedback != ''">feedback,</if>
            <if test="status != null and status != ''">status,</if>
            <!-- 默认未删除 -->
            <if test="delFlag == null">del_flag,</if>
            <if test="createBy != null and createBy != ''">create_by,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateBy != null and updateBy != ''">update_by,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="remark != null and remark != ''">remark,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="roomId != null">#{roomId},</if>
            <if test="reportUserId != null">#{reportUserId},</if>
            <if test="description != null and description != ''">#{description},</if>
            <if test="images != null and images != ''">#{images},</if>
            <if test="workerUserId != null">#{workerUserId},</if>
            <if test="feedback != null and feedback != ''">#{feedback},</if>
            <if test="status != null and status != ''">#{status},</if>
            <!-- 默认未删除 -->
            <if test="delFlag == null">'0',</if>
            <if test="createBy != null and createBy != ''">#{createBy},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateBy != null and updateBy != ''">#{updateBy},</if>
            <if test="updateTime != null">#{updateTime},</if>
            <if test="remark != null and remark != ''">#{remark},</if>
        </trim>
    </insert>

    <!-- 修改维修报修 -->
    <update id="updateDormRepair" parameterType="com.ruoyi.manage.domain.DormRepair">
        update tb_dorm_repair
        <trim prefix="SET" suffixOverrides=",">
            <if test="roomId != null">room_id = #{roomId},</if>
            <if test="reportUserId != null">report_user_id = #{reportUserId},</if>
            <if test="description != null and description != ''">description = #{description},</if>
            <if test="images != null and images != ''">images = #{images},</if>
            <if test="workerUserId != null">worker_user_id = #{workerUserId},</if>
            <if test="feedback != null and feedback != ''">feedback = #{feedback},</if>
            <if test="status != null and status != ''">status = #{status},</if>
            <if test="delFlag != null and delFlag != ''">del_flag = #{delFlag},</if>
            <if test="createBy != null and createBy != ''">create_by = #{createBy},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="updateBy != null and updateBy != ''">update_by = #{updateBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="remark != null and remark != ''">remark = #{remark},</if>
        </trim>
        where repair_id = #{repairId}
        and del_flag = '0'  <!-- 只修改未删除的数据 -->
    </update>

    <!-- 单个删除维修报修（物理删除，若需逻辑删除可改为更新del_flag） -->
    <delete id="deleteDormRepairByRepairId" parameterType="Long">
        delete from tb_dorm_repair
        where repair_id = #{repairId}
    </delete>

    <!-- 批量删除维修报修（修复参数类型为Long数组） -->
    <delete id="deleteDormRepairByRepairIds" parameterType="Long[]">
        delete from tb_dorm_repair
        where repair_id in
        <foreach item="repairId" collection="array" open="(" separator="," close=")">
            #{repairId}
        </foreach>
    </delete>

</mapper>